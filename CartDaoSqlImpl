package com.wipro.eshop.dao; 
 
import java.sql.*; 
import java.util.*; 
import com.wipro.eshop.model.MenuItem; 
import com.wipro.eshop.exception.CartEmptyException; 
 
public class CartDaoSqlImpl implements CartDao { 
  
  
 
 @Override 
 public void addCartItem(long userId, long menuItemId) { 
     try (Connection conn = ConnectionHandler.getConnection()) { 
 
         
         String checkSql = "SELECT me_id FROM menu_item WHERE me_id = ?"; 
         try (PreparedStatement checkStmt = conn.prepareStatement(checkSql)) 
{ 
             checkStmt.setLong(1, menuItemId); 
             ResultSet rs = checkStmt.executeQuery(); 
 
             if (!rs.next()) { 
                 System.out.println("❌ Menu Item ID " + menuItemId + " does 
not exist."); 
                 return; 
             } 
         } 
 
          
         String sql = "INSERT INTO cart (ct_us_id, ct_pr_id) VALUES (?, ?)"; 
         PreparedStatement ps = conn.prepareStatement(sql); 
         ps.setLong(1, userId); 
         ps.setLong(2, menuItemId); 
         ps.executeUpdate(); 
 
         System.out.println("❌ Item added to cart successfully."); 
 
     } catch (SQLException e) { 
         System.out.println("❌ Failed to add item to cart:"); 
         e.printStackTrace();  // Show the actual error 
     } 
 } 
 
    @Override 
    public List<MenuItem> getAllCartItems(long userId) throws CartEmptyException { 
        List<MenuItem> itemList = new ArrayList<>(); 
        try (Connection conn = ConnectionHandler.getConnection()) { 
            String sql = "SELECT * FROM menu_item JOIN cart ON me_id = ct_pr_id 
WHERE ct_us_id = ?"; 
            PreparedStatement ps = conn.prepareStatement(sql); 
            ps.setLong(1, userId); 
            ResultSet rs = ps.executeQuery(); 
 
            while (rs.next()) { 
                MenuItem item = new MenuItem( 
                    rs.getLong("me_id"), 
                    rs.getString("me_name"), 
                    rs.getFloat("me_price"), 
                    rs.getString("me_active").equalsIgnoreCase("Yes"), 
                    rs.getDate("me_date_of_launch"), 
                    rs.getString("me_category"), 
                    rs.getString("me_free_delivery").equalsIgnoreCase("Yes") 
                ); 
                itemList.add(item); 
            } 
 
            if (itemList.isEmpty()) { 
                throw new CartEmptyException("Cart is empty."); 
            } 
 
        } catch (SQLException e) { 
            System.out.println("Database error: " + e.getMessage()); 
        } 
 
        return itemList; 
    } 
 
    @Override 
    public void removeCartItem(long userId, long menuItemId) { 
        try (Connection conn = ConnectionHandler.getConnection()) { 
            String sql = "DELETE FROM cart WHERE ct_us_id = ? AND ct_pr_id = ? 
LIMIT 1"; 
            PreparedStatement ps = conn.prepareStatement(sql); 
            ps.setLong(1, userId); 
            ps.setLong(2, menuItemId); 
            int rowsAffected = ps.executeUpdate(); 
            if (rowsAffected > 0 ) { 
             System.out.println("Item removed from cart."); 
            }else { 
             System.out.println("Item not found in cart."); 
            } 
             
        } catch (Exception e) { 
         System.out.println("Please enter a valid item to be removed");
